version: 2.1

commands:
    install_and_cache_yarn_linux:
        steps:
            - checkout
            - restore_cache:
                  name: restore cache ➡ root
                  keys:
                      - dependencies-linux-root-{{ checksum "yarn.lock" }}
                      # fallback to using the latest cache if no exact match is found
                      - dependencies-linux-root-
            - run:
                  name: yarn ➡ install
                  command: yarn install --frozen-lockfile --cache-folder ~/.cache/yarn
            - save_cache:
                  name: save cache
                  key: dependencies-linux-root-{{ checksum "yarn.lock" }}
                  paths:
                      - ~/.cache/yarn
    run_all_tests:
        steps:
            - run:
                  name: yarn test
                  command: yarn test
    lint:
        steps:
            - run:
                  name: yarn lint
                  command: CI=true yarn lint

    install_and_test:
        steps:
            - install_and_cache_yarn_linux
            - run_all_tests
            - lint

# based on https://github.com/nodejs/Release schedule
jobs:
    node v10:
        docker:
            - image: circleci/node:10
        steps:
            - install_and_test
    node v12:
        docker:
            - image: circleci/node:12
        steps:
            - install_and_test
    node v14:
        docker:
            - image: circleci/node:14
        steps:
            - install_and_test
    node v14_6:
        docker:
            - image: circleci/node:14.6.0
        steps:
            - install_and_test
    node v15:
        docker:
            - image: circleci/node:15
        steps:
            - install_and_test
workflows:
    main:
        jobs:
            - node v10
            - node v12
            - node v14
            - node v14_6
            - node v15
